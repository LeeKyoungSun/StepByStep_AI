# SCSC/scenario/keyword_rules.py
import re

# ----- 텍스트 정규화(띄어쓰기/제로폭문자/비가시 문자 제거) -----
_ZWS_RE = re.compile(r"[\u200B-\u200D\uFEFF\u2060]")
_MULTI_SPACE = re.compile(r"\s+")
def normalize(text: str) -> str:
    if not text:
        return ""
    text = text.replace("\xa0", " ")
    text = _ZWS_RE.sub("", text)
    text = _MULTI_SPACE.sub(" ", text)
    return text

# ----- 키워드 규칙 (한국어/영문/약어/변형 포함) -----
RAW_RULES = {
    "피임": [
        r"콘돔|condom|코[느]돔",
        r"질외\s*사정|사정\s*조절|질외사정",
        r"피임(약|법)|경구\s*피임약|야즈|야스민|미니필",
        r"(응급|사후)\s*피임(약)?|morning\s*after|Plan\s*B",
        r"IUD|자궁내\s*장치|루프|구리\s*IUD|호르몬\s*IUD",
        r"임플(라)?논|임플란트|피임\s*주사|피임\s*패치",
        r"질정|다이어프램",
        r"피임\s*실패|콘돔\s*파손|찢어짐",
    ],
    "생리": [
        r"생리|월경|menstruat|period",
        r"주기|배란|가임기|배란일",
        r"PMS|PMDD|월경\s*전\s*증후군",
        r"생리통|월경통|진통제|온열팩",
        r"탐폰|탐퐁|탐본|생리대|패드|생리컵|컵\s*사용",
        r"스팟팅|출혈|주기\s*변화",
        r"초경|사춘기",
    ],
    "연애": [
        r"연애|사귀|고백|썸|밀당|권태기|이별|데이트",
    ],
    "외모": [
        r"외모|체형|몸매|체중|다이어트|살[뺄빼]|비만|저체중",
        r"여드름|피부|트러블|화장|메이크업|탈모|키|키작|키큰",
        r"바디\s*이미지|신체\s*이미지|자기\s*이미지",
    ],
    "신체 변화": [
        r"사춘기|2차\s*성징|성\s*성숙|발달",
        r"유방\s*발달|가슴|브라|브래지어",
        r"음경|고환|포경|귀두|몽정|발기|성기\s*크기",
        r"겨드랑이\s*털|음모|수염|목소리\s*변화",
    ],
    "젠더": [
        r"성\s*정체성|성별\s*정체성|젠더|젠더\s*표현|성\s*역할",
        r"LGBTQ?\+?|퀴어|트랜스젠더|논\s*바이너리|바이\s*젠더|젠더\s*플루이드",
        r"성적\s*지향|이성애|동성애|양성애|무성애|Asexual",
        r"커밍아웃|misgender|deadname",
    ],
    "관계/의사소통": [
        r"의사\s*소통|소통|대화|경청|피드백|갈등\s*해결",
        r"존중|배려|공감|감정\s*표현|충동\s*조절",
        r"개인\s*정보|비밀\s*보장",
    ],
    "경계/동의": [
        r"동의|consent|컨센트|비동의|거절|노\s*미즈\s*노|no\s*means\s*no",
        r"경계|바운더리|boundary",
        r"압박|강요|위력|권력\s*관계|나이\s*차|선배|교사",
        r"취중|음주|약물|취한\s*상태",
        r"동의는\s*언제든\s*철회",
    ],
    "온라인/디지털": [
        r"디지털\s*성범죄|불법\s*촬영|몰카|리벤지\s*포르노|유포|협박",
        r"N번방|텔레그램|단톡|단체\s*채팅|DM|메신저|카톡|SNS|인스타|틱톡",
        r"사진\s*요구|몸\s*사진|노출\s*사진|계정\s*공유|비번",
        r"온라인\s*동의|저작권|초상권",
    ],
    "성병/검사": [
        r"성\s*병|성\s*감염증|STI|STD|감염",
        r"HPV|인유두종|헤르페스|클라미디아|임질|매독|트리코모나스|HIV|에이즈|B형\s*간염",
        r"검사|테스트|키트|자가\s*검사|신속\s*검사|양성|음성|항체",
        r"보건소|클리닉|익명\s*검사|파트너\s*통보",
        r"잠복기|무증상|재감염",
    ],
    "임신/출산": [
        r"임신|수정|착상|임테기|임신\s*테스트",
        r"초음파|임신\s*주수|입덧|유산",
        r"출산|분만|산후|산후조리",
        r"임신\s*중절|낙태|의료\s*상담",
    ],
    "자위/욕구": [
        r"자위|오나니|masturbat|성적\s*욕구|흥분|판타지|야동|포르노|에로",
    ],
    "건강/상담": [
        r"상담|보건\s*교사|상담\s*사|심리\s*상담",
        r"정신\s*건강|우울|불안|스트레스",
        r"의사|산부인과|비뇨의학과|피임\s*상담|성\s*상담",
        r"헬프라인|전화|지원\s*센터|1366|112",
    ],
}

# ----- 컴파일된 패턴 준비 -----
COMPILED_RULES = {
    k: [re.compile(p, re.IGNORECASE) for p in pats]
    for k, pats in RAW_RULES.items()
}

def match_keywords(text: str):
    text = normalize(text)
    found = []
    for k, pats in COMPILED_RULES.items():
        if any(p.search(text) for p in pats):
            found.append(k)
    # 중복 제거, 순서 유지
    return list(dict.fromkeys(found))